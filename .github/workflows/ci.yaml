name: "Continuous Integration"

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

env:
  AWS_REGION: eu-west-1

jobs:
  discovery:
    name: Discover modules and their examples
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Discover modules and their examples
        id: discovery
        run: |
          set -e

          modules="$(tools/bin/find-modules | jq -Rc '[inputs]')"
          examples="$(tools/bin/find-examples | jq -Rc '[inputs]')"

          echo "::set-output name=modules::$modules"
          echo "::set-output name=examples::$examples"

    outputs:
      modules: ${{ steps.discovery.outputs.modules }}
      examples: ${{ steps.discovery.outputs.examples }}

  providers:
    name: Make sure providers are cached
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      # https://github.com/marketplace/actions/hashicorp-setup-terraform
      - name: Setup Terraform 0.12.x
        uses: hashicorp/setup-terraform@v1
        with:
          terraform_version: 0.12.x

      - name: Setup providers cache
        id: cache_providers
        uses: actions/cache@v2
        with:
          path: ./.terraform/plugins/linux_amd64
          key: ${{ runner.os }}-terraform-providers-${{ hashFiles('./versions.tf') }}
          restore-keys: ${{ runner.os }}-terraform-providers

      - name: Download providers
        id: download_providers
        if: steps.cache_providers.outputs.cache-hit != 'true'
        run: terraform init -backend=false

  check-modules:
    name: Check module ${{ matrix.module }}
    needs: [discovery, providers]
    strategy:
      matrix:
        module: ${{ fromJson(needs.discovery.outputs.modules) }}
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Setup Terraform 0.12.x
        uses: hashicorp/setup-terraform@v1
        with:
          terraform_version: 0.12.x

      - name: Download cached providers
        id: cache_providers
        uses: actions/cache@v2
        with:
          path: ./.terraform/plugins
          key: ${{ runner.os }}-terraform-providers-${{ hashFiles('./versions.tf') }}
          restore-keys: ${{ runner.os }}-terraform-providers

      - name: terraform fmt
        id: terraform_fmt
        run: terraform fmt -check -diff '${{ matrix.module }}'

      - name: terraform init
        id: terraform_init
        run: terraform init -backend=false -plugin-dir=.terraform/plugins/linux_amd64 '${{ matrix.module }}'

      - name: terraform validate
        id: terraform_validate
        run: terraform validate '${{ matrix.module }}'
